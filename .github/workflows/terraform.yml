name: Terraform CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform (plan, apply or destroy)'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'

jobs:
  terraform-checks:
    name: Terraform Format & Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.8.0
      
      - name: Terraform Format Check
        run: |
          echo "Checking HCL formatting..."
          terraform fmt -recursive -check -diff terraform/
        continue-on-error: true
      
      - name: Terraform Validate
        working-directory: ./terraform/terraform
        run: |
          echo "Validating Terraform config..."
          terraform init -backend=false
          terraform validate

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-checks
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
    permissions:
      contents: read
      pull-requests: write
    
    env:
      TF_VAR_yc_token: ${{ secrets.YC_TOKEN }}
      TF_VAR_yc_cloud_id: ${{ secrets.YC_CLOUD_ID }}
      TF_VAR_yc_folder_id: ${{ secrets.YC_FOLDER_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ru-central1
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.8.0
      
      - name: Terraform Init
        working-directory: ./terraform/terraform
        run: |
          terraform init \
            -backend-config="bucket=devops-tfstate" \
            -backend-config="key=infrastructure.tfstate" \
            -backend-config="region=ru-central1" \
            -backend-config="encrypt=true"
      
      - name: Terraform Plan
        working-directory: ./terraform/terraform
        id: plan
        run: |
          terraform plan -out=tfplan -lock=false
        continue-on-error: true
      
      - name: Upload Plan Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/terraform/tfplan
          retention-days: 7

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    permissions:
      contents: read
    
    env:
      TF_VAR_yc_token: ${{ secrets.YC_TOKEN }}
      TF_VAR_yc_cloud_id: ${{ secrets.YC_CLOUD_ID }}
      TF_VAR_yc_folder_id: ${{ secrets.YC_FOLDER_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ru-central1
      TF_LOG: DEBUG
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.8.0
      
      - name: Terraform Init
        working-directory: ./terraform/terraform
        run: |
          terraform init \
            -backend-config="bucket=devops-tfstate" \
            -backend-config="key=infrastructure.tfstate" \
            -backend-config="region=ru-central1" \
            -backend-config="encrypt=true"
      
      - name: Terraform Apply
        working-directory: ./terraform/terraform
        run: |
          terraform apply -auto-approve -lock=false
      
      - name: Save Terraform Outputs
        if: success()
        working-directory: ./terraform/terraform
        run: |
          terraform output -json > terraform_outputs.json
      
      - name: Upload Outputs as Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: terraform/terraform/terraform_outputs.json
          retention-days: 30

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: terraform-checks
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    permissions:
      contents: read
    
    env:
      TF_VAR_yc_token: ${{ secrets.YC_TOKEN }}
      TF_VAR_yc_cloud_id: ${{ secrets.YC_CLOUD_ID }}
      TF_VAR_yc_folder_id: ${{ secrets.YC_FOLDER_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ru-central1
      TF_LOG: DEBUG
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.8.0
      
      - name: Terraform Init
        working-directory: ./terraform/terraform
        run: |
          terraform init \
            -backend-config="bucket=devops-tfstate" \
            -backend-config="key=infrastructure.tfstate" \
            -backend-config="region=ru-central1" \
            -backend-config="encrypt=true"
      
      - name: Terraform Plan Destroy
        working-directory: ./terraform/terraform
        run: |
          echo "WARNING: Planning destruction of all infrastructure!"
          terraform plan -destroy -out=tfdestroy.plan -lock=false
      
      - name: Terraform Destroy
        working-directory: ./terraform/terraform
        run: |
          echo "WARNING: This will DESTROY all infrastructure!"
          echo "Review the plan above before proceeding."
          terraform apply -destroy -auto-approve -lock=false
      
      - name: Confirm Destruction
        if: success()
        run: |
          echo "Infrastructure has been successfully destroyed"
          echo "All Yandex Cloud resources have been deleted"
